<!-- manager.html -->
<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DTM Events - Manager</title>
<style>
  body {
    background: #121212;
    color: #e0e0e0;
    font-family: sans-serif;
    max-width: 600px;
    margin: 3rem auto;
    padding: 1rem;
  }
  h1, h2 {
    color: #4ade80;
    text-align: center;
  }
  .section {
    background: #1f1f1f;
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1.5rem;
  }
  input, button, select, textarea {
    width: 100%;
    padding: 0.6rem;
    margin-top: 0.5rem;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
    box-sizing: border-box;
    background: #2a2a2a;
    color: #e0e0e0;
  }
  button {
    background: #4ade80;
    color: #121212;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.2s;
  }
  button:hover:not(:disabled) {
    background: #22c55e;
  }
  button:disabled {
    background: #555;
    cursor: not-allowed;
  }
  label {
    font-weight: 600;
    margin-top: 0.8rem;
    display: block;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0.5rem;
  }
  th, td {
    padding: 0.5rem;
    border-bottom: 1px solid #333;
    text-align: left;
  }
  th {
    color: #86efac;
  }
  .error {
    color: #f87171;
    font-weight: 700;
    margin-top: 0.5rem;
  }
  .success {
    color: #86efac;
    font-weight: 700;
    margin-top: 0.5rem;
  }
  .hidden {
    display: none;
  }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<h1>DTM Events - Manager</h1>

<div id="loginSection" class="section">
  <h2>Inloggen</h2>
  <label for="passwordInput">Wachtwoord</label>
  <input type="password" id="passwordInput" autocomplete="off" />
  <button id="loginBtn">Login</button>
  <div id="loginMessage" class="error" role="alert" aria-live="assertive"></div>
</div>

<div id="managerContent" class="hidden">

  <div class="section">
    <h2>Events beheren</h2>
    <table id="eventsTable" aria-label="Lijst van events">
      <thead>
        <tr>
          <th>Naam</th>
          <th>Datum & tijd</th>
          <th>Normaal tickets</th>
          <th>VIP tickets</th>
          <th>Acties</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>Nieuw event toevoegen</h3>
    <label for="newEventName">Naam</label>
    <input id="newEventName" type="text" placeholder="Event naam" />
    <label for="newEventDate">Datum en tijd (ISO formaat)</label>
    <input id="newEventDate" type="datetime-local" />
    <button id="addEventBtn">Event toevoegen</button>
    <div id="eventMessage" role="alert" aria-live="polite"></div>
  </div>

  <div class="section">
    <h2>Tickets beheren</h2>
    <label for="selectEventTickets">Selecteer event</label>
    <select id="selectEventTickets"></select>

    <label for="normalTicketsInput">Aantal normale tickets</label>
    <input id="normalTicketsInput" type="number" min="0" />

    <label for="vipTicketsInput">Aantal VIP tickets</label>
    <input id="vipTicketsInput" type="number" min="0" />

    <button id="updateTicketsBtn">Tickets bijwerken</button>
    <button id="resetTicketsBtn" style="background:#f87171;">Reset tickets</button>
    <div id="ticketsMessage" role="alert" aria-live="polite"></div>
  </div>

  <div class="section">
    <h2>VIP codes beheren</h2>

    <table id="vipCodesTable" aria-label="Lijst van VIP codes">
      <thead>
        <tr>
          <th>Code</th>
          <th>Limit</th>
          <th>Gebruikt</th>
          <th>Acties</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>Nieuwe VIP code toevoegen</h3>
    <label for="newVipCode">Code</label>
    <input id="newVipCode" type="text" placeholder="Bijv. VIP123" />
    <label for="newVipLimit">Max gebruik</label>
    <input id="newVipLimit" type="number" min="1" value="1" />
    <button id="addVipCodeBtn">VIP code toevoegen</button>
    <div id="vipMessage" role="alert" aria-live="polite"></div>
  </div>

  <button id="logoutBtn" style="margin-top: 1rem; background:#ef4444;">Uitloggen</button>

</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAq2hnWZnhoMzVC_NZ3efND3xEkijRy23k",
    authDomain: "dtm-evemts.firebaseapp.com",
    databaseURL: "https://dtm-evemts-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "dtm-evemts",
    storageBucket: "dtm-evemts.firebasestorage.app",
    messagingSenderId: "673592896357",
    appId: "1:673592896357:web:4aa0d051ad738c12a80f8c",
    measurementId: "G-GFRH4KY8GF"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Login system
  const passwordInput = document.getElementById('passwordInput');
  const loginBtn = document.getElementById('loginBtn');
  const loginMessage = document.getElementById('loginMessage');
  const loginSection = document.getElementById('loginSection');
  const managerContent = document.getElementById('managerContent');

  const MANAGER_PASSWORD = 'dtmadmin3';

  loginBtn.onclick = () => {
    loginMessage.textContent = '';
    if(passwordInput.value === MANAGER_PASSWORD) {
      loginSection.classList.add('hidden');
      managerContent.classList.remove('hidden');
      loadEventsTable();
      loadEventsForTickets();
      loadVipCodes();
    } else {
      loginMessage.textContent = 'Onjuist wachtwoord.';
    }
  };

  // EVENTS MANAGEMENT
  const eventsTableBody = document.querySelector('#eventsTable tbody');
  const newEventName = document.getElementById('newEventName');
  const newEventDate = document.getElementById('newEventDate');
  const addEventBtn = document.getElementById('addEventBtn');
  const eventMessage = document.getElementById('eventMessage');

  function loadEventsTable() {
    eventsTableBody.innerHTML = '';
    db.ref('events').once('value').then(snap => {
      const events = snap.val() || {};
      for (const key in events) {
        const e = events[key];
        const tr = document.createElement('tr');

        const dateTime = new Date(e.date).toLocaleString('nl-NL', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});

        tr.innerHTML = `
          <td><input type="text" data-key="${key}" class="editEventName" value="${e.name}" /></td>
          <td><input type="datetime-local" data-key="${key}" class="editEventDate" value="${toInputDateTimeLocal(e.date)}" /></td>
          <td><input type="number" min="0" data-key="${key}" class="editNormalTickets" value="${e.tickets?.normal || 0}" /></td>
          <td><input type="number" min="0" data-key="${key}" class="editVipTickets" value="${e.tickets?.vip || 0}" /></td>
          <td>
            <button class="saveEventBtn" data-key="${key}">Opslaan</button>
            <button class="deleteEventBtn" data-key="${key}" style="background:#ef4444;">Verwijderen</button>
          </td>
        `;
        eventsTableBody.appendChild(tr);
      }
      attachEventTableHandlers();
    });
  }

  // Helper voor datetime-local input format
  function toInputDateTimeLocal(dateStr) {
    const d = new Date(dateStr);
    const pad = n => n.toString().padStart(2,'0');
    const YYYY = d.getFullYear();
    const MM = pad(d.getMonth()+1);
    const DD = pad(d.getDate());
    const HH = pad(d.getHours());
    const mm = pad(d.getMinutes());
    return `${YYYY}-${MM}-${DD}T${HH}:${mm}`;
  }

  function attachEventTableHandlers() {
    document.querySelectorAll('.saveEventBtn').forEach(btn => {
      btn.onclick = () => {
        const key = btn.dataset.key;
        const name = document.querySelector(`.editEventName[data-key="${key}"]`).value.trim();
        const date = document.querySelector(`.editEventDate[data-key="${key}"]`).value;
        const normal = parseInt(document.querySelector(`.editNormalTickets[data-key="${key}"]`).value) || 0;
        const vip = parseInt(document.querySelector(`.editVipTickets[data-key="${key}"]`).value) || 0;

        if(!name || !date) {
          eventMessage.textContent = 'Naam en datum zijn verplicht.';
          return;
        }
        eventMessage.textContent = '';

        db.ref(`events/${key}`).update({
          name,
          date: new Date(date).toISOString(),
          tickets: { normal, vip }
        }).then(() => {
          eventMessage.textContent = 'Event opgeslagen!';
          loadEventsTable();
          loadEventsForTickets();
        }).catch(() => {
          eventMessage.textContent = 'Fout bij opslaan event.';
        });
      };
    });

    document.querySelectorAll('.deleteEventBtn').forEach(btn => {
      btn.onclick = () => {
        const key = btn.dataset.key;
        if(confirm('Weet je zeker dat je dit event wilt verwijderen?')) {
          db.ref(`events/${key}`).remove().then(() => {
            eventMessage.textContent = 'Event verwijderd.';
            loadEventsTable();
            loadEventsForTickets();
          });
        }
      };
    });
  }

  addEventBtn.onclick = () => {
    const name = newEventName.value.trim();
    const date = newEventDate.value;
    if(!name || !date) {
      eventMessage.textContent = 'Vul naam en datum in!';
      return;
    }
    eventMessage.textContent = '';
    const newKey = db.ref('events').push().key;
    db.ref(`events/${newKey}`).set({
      name,
      date: new Date(date).toISOString(),
      tickets: { normal: 0, vip: 0 }
    }).then(() => {
      eventMessage.textContent = 'Nieuw event toegevoegd!';
      newEventName.value = '';
      newEventDate.value = '';
      loadEventsTable();
      loadEventsForTickets();
    }).catch(() => {
      eventMessage.textContent = 'Fout bij toevoegen event.';
    });
  };

  // TICKETS MANAGEMENT
  const selectEventTickets = document.getElementById('selectEventTickets');
  const normalTicketsInput = document.getElementById('normalTicketsInput');
  const vipTicketsInput = document.getElementById('vipTicketsInput');
  const updateTicketsBtn = document.getElementById('updateTicketsBtn');
  const resetTicketsBtn = document.getElementById('resetTicketsBtn');
  const ticketsMessage = document.getElementById('ticketsMessage');

  function loadEventsForTickets() {
    selectEventTickets.innerHTML = '';
    db.ref('events').once('value').then(snap => {
      const events = snap.val() || {};
      for (const key in events) {
        const e = events[key];
        selectEventTickets.innerHTML += `<option value="${key}">${e.name}</option>`;
      }
      if(selectEventTickets.options.length) {
        selectEventTickets.selectedIndex = 0;
        loadSelectedEventTickets(selectEventTickets.value);
      }
      selectEventTickets.onchange = () => {
        loadSelectedEventTickets(selectEventTickets.value);
        ticketsMessage.textContent = '';
      };
    });
  }

  function loadSelectedEventTickets(eventKey) {
    db.ref(`events/${eventKey}/tickets`).once('value').then(snap => {
      const tickets = snap.val() || {};
      normalTicketsInput.value = tickets.normal || 0;
      vipTicketsInput.value = tickets.vip || 0;
    });
  }

  updateTicketsBtn.onclick = () => {
    const key = selectEventTickets.value;
    const normal = parseInt(normalTicketsInput.value) || 0;
    const vip = parseInt(vipTicketsInput.value) || 0;
    ticketsMessage.textContent = '';

    db.ref(`events/${key}/tickets`).set({ normal, vip })
      .then(() => {
        ticketsMessage.textContent = 'Tickets bijgewerkt!';
        loadEventsTable();
      })
      .catch(() => {
        ticketsMessage.textContent = 'Fout bij bijwerken tickets.';
      });
  };

  resetTicketsBtn.onclick = () => {
    if(!confirm('Weet je zeker dat je alle tickets voor dit event wilt resetten naar 0?')) return;
    const key = selectEventTickets.value;
    db.ref(`events/${key}/tickets`).set({ normal: 0, vip: 0 })
      .then(() => {
        ticketsMessage.textContent = 'Tickets gereset naar 0!';
        loadSelectedEventTickets(key);
        loadEventsTable();
      })
      .catch(() => {
        ticketsMessage.textContent = 'Fout bij resetten tickets.';
      });
  };

  // VIP CODES MANAGEMENT
  const vipCodesTableBody = document.querySelector('#vipCodesTable tbody');
  const newVipCode = document.getElementById('newVipCode');
  const newVipLimit = document.getElementById('newVipLimit');
  const addVipCodeBtn = document.getElementById('addVipCodeBtn');
  const vipMessage = document.getElementById('vipMessage');

  function loadVipCodes() {
    vipCodesTableBody.innerHTML = '';
    db.ref('vipPasswords').once('value').then(snap => {
      const codes = snap.val() || {};
      for(const code in codes) {
        const d = codes[code];
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${code}</td>
          <td><input type="number" min="1" data-code="${code}" class="editVipLimit" value="${d.limit || 1}" /></td>
          <td>${d.used || 0}</td>
          <td>
            <button class="saveVipBtn" data-code="${code}">Opslaan</button>
            <button class="resetVipBtn" data-code="${code}" style="background:#f87171;">Reset gebruik</button>
            <button class="deleteVipBtn" data-code="${code}" style="background:#ef4444;">Verwijderen</button>
          </td>
        `;
        vipCodesTableBody.appendChild(tr);
      }
      attachVipHandlers();
    });
  }

  function attachVipHandlers() {
    document.querySelectorAll('.saveVipBtn').forEach(btn => {
      btn.onclick = () => {
        const code = btn.dataset.code;
        const limitInput = document.querySelector(`.editVipLimit[data-code="${code}"]`);
        const limit = parseInt(limitInput.value) || 1;
        if(limit < 1) {
          vipMessage.textContent = 'Limit moet minimaal 1 zijn.';
          return;
        }
        vipMessage.textContent = '';
        db.ref(`vipPasswords/${code}`).update({ limit })
          .then(() => {
            vipMessage.textContent = 'VIP code bijgewerkt!';
            loadVipCodes();
          })
          .catch(() => {
            vipMessage.textContent = 'Fout bij bijwerken VIP code.';
          });
      };
    });

    document.querySelectorAll('.resetVipBtn').forEach(btn => {
      btn.onclick = () => {
        const code = btn.dataset.code;
        if(!confirm(`Reset gebruik voor VIP code "${code}"?`)) return;
        db.ref(`vipPasswords/${code}/used`).set(0)
          .then(() => {
            vipMessage.textContent = 'Gebruik gereset!';
            loadVipCodes();
          })
          .catch(() => {
            vipMessage.textContent = 'Fout bij resetten gebruik.';
          });
      };
    });

    document.querySelectorAll('.deleteVipBtn').forEach(btn => {
      btn.onclick = () => {
        const code = btn.dataset.code;
        if(!confirm(`Weet je zeker dat je VIP code "${code}" wilt verwijderen?`)) return;
        db.ref(`vipPasswords/${code}`).remove()
          .then(() => {
            vipMessage.textContent = 'VIP code verwijderd!';
            loadVipCodes();
          })
          .catch(() => {
            vipMessage.textContent = 'Fout bij verwijderen VIP code.';
          });
      };
    });
  }

  addVipCodeBtn.onclick = () => {
    const code = newVipCode.value.trim();
    const limit = parseInt(newVipLimit.value) || 1;
    if(!code) {
      vipMessage.textContent = 'Voer een VIP code in.';
      return;
    }
    if(limit < 1) {
      vipMessage.textContent = 'Limit moet minimaal 1 zijn.';
      return;
    }
    vipMessage.textContent = '';
    db.ref(`vipPasswords/${code}`).set({ limit, used: 0 })
      .then(() => {
        vipMessage.textContent = 'VIP code toegevoegd!';
        newVipCode.value = '';
        newVipLimit.value = '1';
        loadVipCodes();
      })
      .catch(() => {
        vipMessage.textContent = 'Fout bij toevoegen VIP code.';
      });
  };

  // LOGOUT
  const logoutBtn = document.getElementById('logoutBtn');
  logoutBtn.onclick = () => {
    managerContent.classList.add('hidden');
    loginSection.classList.remove('hidden');
    passwordInput.value = '';
    loginMessage.textContent = '';
  };
</script>

</body>
</html>
