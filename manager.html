<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DTM Events - Manager</title>
<style>
  body {
    background: #121212;
    color: #e0e0e0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    max-width: 800px;  /* Iets breder */
    margin: 3rem auto;
    padding: 1.5rem 2rem;
  }
  h1, h2 {
    color: #4ade80;
    text-align: center;
    margin-bottom: 0.8rem;
  }
  .section {
    background: #1f1f1f;
    border-radius: 10px;
    padding: 1.5rem 2rem;
    margin-bottom: 2rem;
    box-sizing: border-box;
  }
  input, button, select, textarea {
    width: 100%;
    padding: 0.7rem 0.9rem;
    margin-top: 0.6rem;
    border-radius: 8px;
    border: none;
    font-size: 1.05rem;
    box-sizing: border-box;
    background: #2a2a2a;
    color: #e0e0e0;
    transition: background-color 0.2s ease;
  }
  button {
    background: #4ade80;
    color: #121212;
    font-weight: 700;
    cursor: pointer;
    user-select: none;
    margin-top: 1rem;
    transition: background-color 0.25s ease;
  }
  button:hover:not(:disabled) {
    background: #22c55e;
  }
  button:disabled {
    background: #555;
    cursor: not-allowed;
  }
  label {
    font-weight: 600;
    margin-top: 1rem;
    display: block;
    font-size: 1.1rem;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0.8rem;
    table-layout: fixed;
  }
  th, td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #333;
    text-align: left;
    word-wrap: break-word;
    font-size: 1rem;
  }
  th {
    color: #86efac;
    font-weight: 600;
  }
  .error {
    color: #f87171;
    font-weight: 700;
    margin-top: 0.5rem;
  }
  .success {
    color: #86efac;
    font-weight: 700;
    margin-top: 0.5rem;
  }
  .hidden {
    display: none;
  }
  /* Buttons in tables kleiner */
  .saveEventBtn, .deleteEventBtn, .deleteVipCodeBtn {
    padding: 0.3rem 0.6rem;
    font-size: 0.9rem;
    margin-right: 0.4rem;
    border-radius: 6px;
    user-select: none;
  }
  .deleteEventBtn, .deleteVipCodeBtn {
    background: #ef4444;
    color: #fff;
  }
  .deleteEventBtn:hover, .deleteVipCodeBtn:hover {
    background: #dc2626;
  }
  /* Home knop bovenaan */
  #homeBtn {
    background: #2563eb;
    color: white;
    font-weight: 700;
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    user-select: none;
    margin-bottom: 1.5rem;
    display: block;
    width: fit-content;
  }
  #homeBtn:hover {
    background: #1d4ed8;
  }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<h1>DTM Events - Manager</h1>

<button id="homeBtn" aria-label="Ga naar homepagina">Home</button>

<div id="loginSection" class="section">
  <h2>Inloggen</h2>
  <label for="passwordInput">Wachtwoord</label>
  <input type="password" id="passwordInput" autocomplete="off" />
  <button id="loginBtn">Login</button>
  <div id="loginMessage" class="error" role="alert" aria-live="assertive"></div>
</div>

<div id="managerContent" class="hidden">

  <div class="section">
    <h2>Events beheren</h2>
    <table id="eventsTable" aria-label="Lijst van events">
      <thead>
        <tr>
          <th>Naam</th>
          <th>Datum & tijd</th>
          <th>Normaal tickets</th>
          <th>VIP tickets</th>
          <th>Status</th>
          <th>Acties</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>Nieuw event toevoegen</h3>
    <label for="newEventName">Naam</label>
    <input id="newEventName" type="text" placeholder="Event naam" />
    <label for="newEventDate">Datum en tijd</label>
    <input id="newEventDate" type="datetime-local" />
    <button id="addEventBtn">Event toevoegen</button>
    <div id="eventMessage" role="alert" aria-live="polite"></div>
  </div>

  <div class="section">
    <h2>Tickets beheren</h2>
    <label for="selectEventTickets">Selecteer event</label>
    <select id="selectEventTickets" aria-label="Selecteer event voor tickets"></select>

    <label for="normalTicketsInput">Aantal normale tickets</label>
    <input id="normalTicketsInput" type="number" min="0" />

    <label for="vipTicketsInput">Aantal VIP tickets</label>
    <input id="vipTicketsInput" type="number" min="0" />

    <button id="updateTicketsBtn">Tickets bijwerken</button>
    <button id="resetTicketsBtn" style="background:#f87171;">Reset tickets</button>
    <div id="ticketsMessage" role="alert" aria-live="polite"></div>
  </div>

  <div class="section">
    <h2>VIP codes beheren</h2>

    <table id="vipCodesTable" aria-label="Lijst van VIP codes">
      <thead>
        <tr>
          <th>Code</th>
          <th>Limit</th>
          <th>Gebruikt</th>
          <th>Acties</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>Nieuwe VIP code toevoegen</h3>
    <label for="newVipCode">Code</label>
    <input id="newVipCode" type="text" placeholder="Bijv. VIP123" />
    <label for="newVipLimit">Max gebruik</label>
    <input id="newVipLimit" type="number" min="1" value="1" />
    <button id="addVipCodeBtn">VIP code toevoegen</button>
    <div id="vipMessage" role="alert" aria-live="polite"></div>
  </div>

  <button id="logoutBtn" style="margin-top: 1rem; background:#ef4444;">Uitloggen</button>

</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAq2hnWZnhoMzVC_NZ3efND3xEkijRy23k",
    authDomain: "dtm-evemts.firebaseapp.com",
    databaseURL: "https://dtm-evemts-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "dtm-evemts",
    storageBucket: "dtm-evemts.firebasestorage.app",
    messagingSenderId: "673592896357",
    appId: "1:673592896357:web:4aa0d051ad738c12a80f8c",
    measurementId: "G-GFRH4KY8GF"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const passwordInput = document.getElementById('passwordInput');
  const loginBtn = document.getElementById('loginBtn');
  const loginMessage = document.getElementById('loginMessage');
  const loginSection = document.getElementById('loginSection');
  const managerContent = document.getElementById('managerContent');

  const MANAGER_PASSWORD = 'dtmadmin3';

  loginBtn.onclick = () => {
    loginMessage.textContent = '';
    if(passwordInput.value === MANAGER_PASSWORD) {
      loginSection.classList.add('hidden');
      managerContent.classList.remove('hidden');
      loadEvents();
      loadVipCodes();
      populateSelectEvents();
    } else {
      loginMessage.textContent = 'Onjuist wachtwoord!';
    }
  };

  document.getElementById('logoutBtn').onclick = () => {
    managerContent.classList.add('hidden');
    loginSection.classList.remove('hidden');
    passwordInput.value = '';
    loginMessage.textContent = '';
  };

  // Home knop link
  document.getElementById('homeBtn').onclick = () => {
    window.location.href = '/'; // Pas aan indien nodig
  };

  // --- Events ---
  const eventsTableBody = document.querySelector('#eventsTable tbody');
  const newEventName = document.getElementById('newEventName');
  const newEventDate = document.getElementById('newEventDate');
  const addEventBtn = document.getElementById('addEventBtn');
  const eventMessage = document.getElementById('eventMessage');

  function formatDateTime(isoStr) {
    const d = new Date(isoStr);
    if(isNaN(d)) return "Ongeldige datum";
    return d.toLocaleString('nl-NL', {dateStyle:'short', timeStyle:'short'});
  }

  // Bepaal event status
  function getEventStatus(event) {
    const now = Date.now();
    const start = new Date(event.date).getTime();
    if (now > start) return "Afgelopen";
    // Check tickets
    const normaleTickets = event.normaleTickets ?? 0;
    const vipTickets = event.vipTickets ?? 0;
    const normaleVerkocht = event.normaleVerkocht ?? 0;
    const vipVerkocht = event.vipVerkocht ?? 0;

    if ((normaleVerkocht >= normaleTickets) && (vipVerkocht >= vipTickets)) {
      return "Vol";
    }
    return "Open";
  }

  function loadEvents() {
    eventsTableBody.innerHTML = '';
    db.ref('events').once('value', snapshot => {
      const events = snapshot.val() || {};
      Object.entries(events).forEach(([key, event]) => {
        const tr = document.createElement('tr');

        // Naam editable
        const nameTd = document.createElement('td');
        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.value = event.naam || '';
        nameInput.style.background = '#2a2a2a';
        nameTd.appendChild(nameInput);
        tr.appendChild(nameTd);

        // Datum editable
        const dateTd = document.createElement('td');
        const dateInput = document.createElement('input');
        dateInput.type = 'datetime-local';
        // Converteer ISO naar datetime-local waarde (yyyy-MM-ddThh:mm)
        const dt = new Date(event.date);
        if(!isNaN(dt)) {
          const pad = n => n.toString().padStart(2,'0');
          const localStr = dt.getFullYear() + '-' + pad(dt.getMonth()+1) + '-' + pad(dt.getDate()) + 'T' + pad(dt.getHours()) + ':' + pad(dt.getMinutes());
          dateInput.value = localStr;
        }
        dateInput.style.background = '#2a2a2a';
        dateTd.appendChild(dateInput);
        tr.appendChild(dateTd);

        // Normale tickets
        const normaleTd = document.createElement('td');
        const normaleInput = document.createElement('input');
        normaleInput.type = 'number';
        normaleInput.min = 0;
        normaleInput.value = event.normaleTickets ?? 0;
        normaleInput.style.background = '#2a2a2a';
        normaleTd.appendChild(normaleInput);
        tr.appendChild(normaleTd);

        // VIP tickets
        const vipTd = document.createElement('td');
        const vipInput = document.createElement('input');
        vipInput.type = 'number';
        vipInput.min = 0;
        vipInput.value = event.vipTickets ?? 0;
        vipInput.style.background = '#2a2a2a';
        vipTd.appendChild(vipInput);
        tr.appendChild(vipTd);

        // Status
        const statusTd = document.createElement('td');
        statusTd.textContent = getEventStatus(event);
        tr.appendChild(statusTd);

        // Acties
        const actionsTd = document.createElement('td');
        // Save knop
        const saveBtn = document.createElement('button');
        saveBtn.textContent = 'Opslaan';
        saveBtn.classList.add('saveEventBtn');
        saveBtn.onclick = () => {
          const newName = nameInput.value.trim();
          const newDate = dateInput.value;
          const normaleVal = parseInt(normaleInput.value, 10);
          const vipVal = parseInt(vipInput.value, 10);

          if(!newName) {
            alert('Naam mag niet leeg zijn');
            return;
          }
          if(!newDate) {
            alert('Datum en tijd is verplicht');
            return;
          }

          const eventUpdate = {
            naam: newName,
            date: new Date(newDate).toISOString(),
            normaleTickets: normaleVal >= 0 ? normaleVal : 0,
            vipTickets: vipVal >= 0 ? vipVal : 0,
          };
          db.ref('events/' + key).update(eventUpdate).then(() => {
            statusTd.textContent = getEventStatus({...event, ...eventUpdate});
            loadEvents();
            populateSelectEvents();
          }).catch(e => alert('Fout bij opslaan: ' + e.message));
        };
        actionsTd.appendChild(saveBtn);

        // Delete knop
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Verwijder';
        deleteBtn.classList.add('deleteEventBtn');
        deleteBtn.onclick = () => {
          if(confirm(`Weet je zeker dat je event "${event.naam}" wilt verwijderen?`)) {
            db.ref('events/' + key).remove().then(() => {
              loadEvents();
              populateSelectEvents();
              clearTicketsInputs();
            });
          }
        };
        actionsTd.appendChild(deleteBtn);
        tr.appendChild(actionsTd);

        eventsTableBody.appendChild(tr);
      });
    });
  }

  addEventBtn.onclick = () => {
    eventMessage.textContent = '';
    const naam = newEventName.value.trim();
    const datum = newEventDate.value;
    if(!naam) {
      eventMessage.textContent = 'Vul een naam in.';
      return;
    }
    if(!datum) {
      eventMessage.textContent = 'Vul een datum en tijd in.';
      return;
    }
    const newEvent = {
      naam,
      date: new Date(datum).toISOString(),
      normaleTickets: 0,
      vipTickets: 0,
      normaleVerkocht: 0,
      vipVerkocht: 0,
    };
    db.ref('events').push(newEvent).then(() => {
      eventMessage.textContent = 'Event toegevoegd!';
      newEventName.value = '';
      newEventDate.value = '';
      loadEvents();
      populateSelectEvents();
    }).catch(e => eventMessage.textContent = 'Fout: ' + e.message);
  };

  // --- Tickets beheren ---
  const selectEventTickets = document.getElementById('selectEventTickets');
  const normalTicketsInput = document.getElementById('normalTicketsInput');
  const vipTicketsInput = document.getElementById('vipTicketsInput');
  const updateTicketsBtn = document.getElementById('updateTicketsBtn');
  const resetTicketsBtn = document.getElementById('resetTicketsBtn');
  const ticketsMessage = document.getElementById('ticketsMessage');

  function populateSelectEvents() {
    selectEventTickets.innerHTML = '<option value="">-- Kies event --</option>';
    db.ref('events').once('value', snapshot => {
      const events = snapshot.val() || {};
      Object.entries(events).forEach(([key, event]) => {
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = event.naam;
        selectEventTickets.appendChild(opt);
      });
    });
  }

  function clearTicketsInputs() {
    normalTicketsInput.value = '';
    vipTicketsInput.value = '';
  }

  selectEventTickets.onchange = () => {
    ticketsMessage.textContent = '';
    const key = selectEventTickets.value;
    if(!key) {
      clearTicketsInputs();
      return;
    }
    db.ref('events/' + key).once('value').then(snapshot => {
      const ev = snapshot.val();
      if(ev) {
        normalTicketsInput.value = ev.normaleTickets ?? 0;
        vipTicketsInput.value = ev.vipTickets ?? 0;
      }
    });
  };

  updateTicketsBtn.onclick = () => {
    ticketsMessage.textContent = '';
    const key = selectEventTickets.value;
    if(!key) {
      ticketsMessage.textContent = 'Selecteer een event.';
      return;
    }
    const normale = parseInt(normalTicketsInput.value, 10);
    const vip = parseInt(vipTicketsInput.value, 10);
    if(isNaN(normale) || normale < 0 || isNaN(vip) || vip < 0) {
      ticketsMessage.textContent = 'Voer geldige aantallen in.';
      return;
    }
    db.ref('events/' + key).update({
      normaleTickets: normale,
      vipTickets: vip
    }).then(() => {
      ticketsMessage.textContent = 'Tickets bijgewerkt!';
      loadEvents();
    }).catch(e => {
      ticketsMessage.textContent = 'Fout: ' + e.message;
    });
  };

  resetTicketsBtn.onclick = () => {
    ticketsMessage.textContent = '';
    const key = selectEventTickets.value;
    if(!key) {
      ticketsMessage.textContent = 'Selecteer een event.';
      return;
    }
    if(confirm('Weet je zeker dat je de verkochte tickets wilt resetten?')) {
      db.ref('events/' + key).update({
        normaleVerkocht: 0,
        vipVerkocht: 0
      }).then(() => {
        ticketsMessage.textContent = 'Verkochte tickets gereset!';
        loadEvents();
      }).catch(e => {
        ticketsMessage.textContent = 'Fout: ' + e.message;
      });
    }
  };

  // --- VIP codes ---
  const vipCodesTableBody = document.querySelector('#vipCodesTable tbody');
  const newVipCodeInput = document.getElementById('newVipCode');
  const newVipLimitInput = document.getElementById('newVipLimit');
  const addVipCodeBtn = document.getElementById('addVipCodeBtn');
  const vipMessage = document.getElementById('vipMessage');

  function loadVipCodes() {
    vipCodesTableBody.innerHTML = '';
    db.ref('vipcodes').once('value', snapshot => {
      const vipcodes = snapshot.val() || {};
      Object.entries(vipcodes).forEach(([key, vip]) => {
        const tr = document.createElement('tr');

        const codeTd = document.createElement('td');
        codeTd.textContent = vip.code || '';
        tr.appendChild(codeTd);

        const limitTd = document.createElement('td');
        limitTd.textContent = vip.limit || 0;
        tr.appendChild(limitTd);

        const usedTd = document.createElement('td');
        usedTd.textContent = vip.used || 0;
        tr.appendChild(usedTd);

        const actionsTd = document.createElement('td');
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Verwijder';
        deleteBtn.classList.add('deleteVipCodeBtn');
        deleteBtn.onclick = () => {
          if(confirm(`Weet je zeker dat je VIP code "${vip.code}" wilt verwijderen?`)) {
            db.ref('vipcodes/' + key).remove().then(() => {
              loadVipCodes();
            });
          }
        };
        actionsTd.appendChild(deleteBtn);
        tr.appendChild(actionsTd);

        vipCodesTableBody.appendChild(tr);
      });
    });
  }

  addVipCodeBtn.onclick = () => {
    vipMessage.textContent = '';
    const code = newVipCodeInput.value.trim();
    const limit = parseInt(newVipLimitInput.value, 10);
    if(!code) {
      vipMessage.textContent = 'Voer een VIP code in.';
      return;
    }
    if(isNaN(limit) || limit < 1) {
      vipMessage.textContent = 'Voer een geldige limiet in (minimaal 1).';
      return;
    }
    // Uniek maken: maak een key met push()
    const newCode = {
      code,
      limit,
      used: 0,
    };
    db.ref('vipcodes').push(newCode).then(() => {
      vipMessage.textContent = 'VIP code toegevoegd!';
      newVipCodeInput.value = '';
      newVipLimitInput.value = '1';
      loadVipCodes();
    }).catch(e => vipMessage.textContent = 'Fout: ' + e.message);
  };
</script>

</body>
</html>
