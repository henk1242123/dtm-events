<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DTM Events - Manager</title>
<style>
  body {
    background: #121212;
    color: #e0e0e0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    max-width: 720px;  /* Iets breder dan 600 */
    margin: 3rem auto;
    padding: 1.5rem 2rem;
  }

  h1, h2 {
    color: #4ade80;
    text-align: center;
    margin-bottom: 0.8rem;
  }

  .section {
    background: #1f1f1f;
    border-radius: 10px;
    padding: 1.5rem 2rem;
    margin-bottom: 2rem;
    box-sizing: border-box;
  }

  input, button, select, textarea {
    width: 100%;
    padding: 0.7rem 0.9rem;
    margin-top: 0.6rem;
    border-radius: 8px;
    border: none;
    font-size: 1.05rem;
    box-sizing: border-box;
    background: #2a2a2a;
    color: #e0e0e0;
    transition: background-color 0.2s ease;
  }

  button {
    background: #4ade80;
    color: #121212;
    font-weight: 700;
    cursor: pointer;
    user-select: none;
    margin-top: 1rem;
    transition: background-color 0.25s ease;
  }

  button:hover:not(:disabled) {
    background: #22c55e;
  }

  button:disabled {
    background: #555;
    cursor: not-allowed;
  }

  label {
    font-weight: 600;
    margin-top: 1rem;
    display: block;
    font-size: 1.1rem;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0.8rem;
    table-layout: fixed;
  }

  th, td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #333;
    text-align: left;
    word-wrap: break-word;
    font-size: 1rem;
  }

  th {
    color: #86efac;
    font-weight: 600;
  }

  .error {
    color: #f87171;
    font-weight: 700;
    margin-top: 0.5rem;
  }

  .success {
    color: #86efac;
    font-weight: 700;
    margin-top: 0.5rem;
  }

  .hidden {
    display: none;
  }

  /* Buttons in tables smaller and tighter */
  .saveEventBtn, .deleteEventBtn, .deleteVipCodeBtn {
    padding: 0.3rem 0.6rem;
    font-size: 0.9rem;
    margin-right: 0.4rem;
    border-radius: 6px;
  }

  .deleteEventBtn, .deleteVipCodeBtn {
    background: #ef4444;
    color: #fff;
  }

  .deleteEventBtn:hover, .deleteVipCodeBtn:hover {
    background: #dc2626;
  }

  /* Home button styling */
  #homeBtn {
    background: #3b82f6;
    color: white;
    font-weight: 700;
    cursor: pointer;
    user-select: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    border: none;
    margin-bottom: 1rem;
    transition: background-color 0.25s ease;
    display: none; /* Default hidden, show only when logged in */
  }

  #homeBtn:hover {
    background: #2563eb;
  }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<h1>DTM Events - Manager</h1>

<button id="homeBtn" aria-label="Ga naar homepagina">Home</button>

<div id="loginSection" class="section">
  <h2>Inloggen</h2>
  <label for="passwordInput">Wachtwoord</label>
  <input type="password" id="passwordInput" autocomplete="off" />
  <button id="loginBtn">Login</button>
  <div id="loginMessage" class="error" role="alert" aria-live="assertive"></div>
</div>

<div id="managerContent" class="hidden">

  <div class="section">
    <h2>Events beheren</h2>
    <table id="eventsTable" aria-label="Lijst van events">
      <thead>
        <tr>
          <th>Naam</th>
          <th>Datum & tijd</th>
          <th>Normaal tickets</th>
          <th>VIP tickets</th>
          <th>Status</th>
          <th>Acties</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>Nieuw event toevoegen</h3>
    <label for="newEventName">Naam</label>
    <input id="newEventName" type="text" placeholder="Event naam" />
    <label for="newEventDate">Datum en tijd (ISO formaat)</label>
    <input id="newEventDate" type="datetime-local" />
    <button id="addEventBtn">Event toevoegen</button>
    <div id="eventMessage" role="alert" aria-live="polite"></div>
  </div>

  <div class="section">
    <h2>Tickets beheren</h2>
    <label for="selectEventTickets">Selecteer event</label>
    <select id="selectEventTickets"></select>

    <label for="normalTicketsInput">Aantal normale tickets</label>
    <input id="normalTicketsInput" type="number" min="0" />

    <label for="vipTicketsInput">Aantal VIP tickets</label>
    <input id="vipTicketsInput" type="number" min="0" />

    <button id="updateTicketsBtn">Tickets bijwerken</button>
    <button id="resetTicketsBtn" style="background:#f87171;">Reset tickets</button>
    <div id="ticketsMessage" role="alert" aria-live="polite"></div>
  </div>

  <div class="section">
    <h2>VIP codes beheren</h2>

    <table id="vipCodesTable" aria-label="Lijst van VIP codes">
      <thead>
        <tr>
          <th>Code</th>
          <th>Limit</th>
          <th>Gebruikt</th>
          <th>Acties</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>Nieuwe VIP code toevoegen</h3>
    <label for="newVipCode">Code</label>
    <input id="newVipCode" type="text" placeholder="Bijv. VIP123" />
    <label for="newVipLimit">Max gebruik</label>
    <input id="newVipLimit" type="number" min="1" value="1" />
    <button id="addVipCodeBtn">VIP code toevoegen</button>
    <div id="vipMessage" role="alert" aria-live="polite"></div>
  </div>

  <button id="logoutBtn" style="margin-top: 1rem; background:#ef4444;">Uitloggen</button>

</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAq2hnWZnhoMzVC_NZ3efND3xEkijRy23k",
    authDomain: "dtm-evemts.firebaseapp.com",
    databaseURL: "https://dtm-evemts-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "dtm-evemts",
    storageBucket: "dtm-evemts.firebasestorage.app",
    messagingSenderId: "673592896357",
    appId: "1:673592896357:web:4aa0d051ad738c12a80f8c",
    measurementId: "G-GFRH4KY8GF"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Login system
  const passwordInput = document.getElementById('passwordInput');
  const loginBtn = document.getElementById('loginBtn');
  const loginMessage = document.getElementById('loginMessage');
  const loginSection = document.getElementById('loginSection');
  const managerContent = document.getElementById('managerContent');
  const homeBtn = document.getElementById('homeBtn');

  const MANAGER_PASSWORD = 'dtmadmin3';

  loginBtn.onclick = () => {
    loginMessage.textContent = '';
    if(passwordInput.value === MANAGER_PASSWORD) {
      loginSection.classList.add('hidden');
      managerContent.classList.remove('hidden');
      homeBtn.style.display = 'inline-block';
      loadEventsTable();
      loadEventsForTickets();
      loadVipCodes();
    } else {
      loginMessage.textContent = 'Onjuist wachtwoord.';
    }
  };

  homeBtn.onclick = () => {
    // Ga terug naar login/home
    managerContent.classList.add('hidden');
    loginSection.classList.remove('hidden');
    homeBtn.style.display = 'none';
    passwordInput.value = '';
    loginMessage.textContent = '';
  };

  // EVENTS MANAGEMENT
  const eventsTableBody = document.querySelector('#eventsTable tbody');
  const newEventName = document.getElementById('newEventName');
  const newEventDate = document.getElementById('newEventDate');
  const addEventBtn = document.getElementById('addEventBtn');
  const eventMessage = document.getElementById('eventMessage');

  function loadEventsTable() {
    eventsTableBody.innerHTML = '';
    db.ref('events').once('value').then(snap => {
      const events = snap.val() || {};
      for (const key in events) {
        const e = events[key];
        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td><input type="text" data-key="${key}" class="editEventName" value="${escapeHtml(e.name)}" /></td>
          <td><input type="datetime-local" data-key="${key}" class="editEventDate" value="${toInputDateTimeLocal(e.date)}" /></td>
          <td><input type="number" min="0" data-key="${key}" class="editNormalTickets" value="${e.tickets?.normal || 0}" /></td>
          <td><input type="number" min="0" data-key="${key}" class="editVipTickets" value="${e.tickets?.vip || 0}" /></td>
          <td>
            <select data-key="${key}" class="editEventStatus" aria-label="Status event">
              <option value="gewoon" ${(!e.status || e.status === 'gewoon') ? 'selected' : ''}>Gewoon</option>
              <option value="wordt_mogelijk_afgelast" ${e.status === 'wordt_mogelijk_afgelast' ? 'selected' : ''}>Wordt mogelijk afgelast</option>
              <option value="geannuleerd" ${e.status === 'geannuleerd' ? 'selected' : ''}>Geannuleerd</option>
            </select>
          </td>
          <td>
            <button class="saveEventBtn" data-key="${key}">Opslaan</button>
            <button class="deleteEventBtn" data-key="${key}">Verwijderen</button>
          </td>
        `;
        eventsTableBody.appendChild(tr);
      }

      // Save knop event listener
      document.querySelectorAll('.saveEventBtn').forEach(btn => {
        btn.onclick = () => {
          const key = btn.dataset.key;
          const tr = btn.closest('tr');
          const name = tr.querySelector('.editEventName').value.trim();
          const date = tr.querySelector('.editEventDate').value;
          const normalTickets = parseInt(tr.querySelector('.editNormalTickets').value) || 0;
          const vipTickets = parseInt(tr.querySelector('.editVipTickets').value) || 0;
          const status = tr.querySelector('.editEventStatus').value;

          if (!name) {
            alert('Naam is verplicht.');
            return;
          }
          if (!date) {
            alert('Datum en tijd zijn verplicht.');
            return;
          }

          const updateData = {
            name,
            date,
            tickets: {
              normal: normalTickets,
              vip: vipTickets,
            },
            status,
          };

          db.ref('events/' + key).update(updateData)
            .then(() => {
              alert('Event opgeslagen.');
              loadEventsTable();
              loadEventsForTickets();
            })
            .catch(() => alert('Opslaan mislukt.'));
        };
      });

      // Delete knop event listener
      document.querySelectorAll('.deleteEventBtn').forEach(btn => {
        btn.onclick = () => {
          if (!confirm('Weet je zeker dat je dit event wilt verwijderen?')) return;
          const key = btn.dataset.key;
          db.ref('events/' + key).remove()
            .then(() => {
              alert('Event verwijderd.');
              loadEventsTable();
              loadEventsForTickets();
            })
            .catch(() => alert('Verwijderen mislukt.'));
        };
      });
    });
  }

  addEventBtn.onclick = () => {
    eventMessage.textContent = '';
    const name = newEventName.value.trim();
    const date = newEventDate.value;

    if (!name) {
      eventMessage.textContent = 'Naam is verplicht.';
      eventMessage.className = 'error';
      return;
    }
    if (!date) {
      eventMessage.textContent = 'Datum en tijd zijn verplicht.';
      eventMessage.className = 'error';
      return;
    }

    const newEventData = {
      name,
      date,
      tickets: { normal: 0, vip: 0 },
      status: 'gewoon'
    };

    const newKey = db.ref().child('events').push().key;
    db.ref('events/' + newKey).set(newEventData)
      .then(() => {
        eventMessage.textContent = 'Event toegevoegd!';
        eventMessage.className = 'success';
        newEventName.value = '';
        newEventDate.value = '';
        loadEventsTable();
        loadEventsForTickets();
      })
      .catch(() => {
        eventMessage.textContent = 'Toevoegen mislukt.';
        eventMessage.className = 'error';
      });
  };

  // TICKETS MANAGEMENT
  const selectEventTickets = document.getElementById('selectEventTickets');
  const normalTicketsInput = document.getElementById('normalTicketsInput');
  const vipTicketsInput = document.getElementById('vipTicketsInput');
  const updateTicketsBtn = document.getElementById('updateTicketsBtn');
  const resetTicketsBtn = document.getElementById('resetTicketsBtn');
  const ticketsMessage = document.getElementById('ticketsMessage');

  function loadEventsForTickets() {
    selectEventTickets.innerHTML = '<option value="">-- Selecteer event --</option>';
    db.ref('events').once('value').then(snap => {
      const events = snap.val() || {};
      for (const key in events) {
        const e = events[key];
        const statusLabel = (e.status && e.status !== 'gewoon') ? ` (${statusText(e.status)})` : '';
        const option = document.createElement('option');
        option.value = key;
        option.textContent = e.name + statusLabel;
        selectEventTickets.appendChild(option);
      }
    });
  }

  selectEventTickets.onchange = () => {
    ticketsMessage.textContent = '';
    const eventId = selectEventTickets.value;
    if (!eventId) {
      normalTicketsInput.value = '';
      vipTicketsInput.value = '';
      return;
    }
    db.ref('events/' + eventId).once('value').then(snap => {
      const e = snap.val();
      normalTicketsInput.value = e?.tickets?.normal ?? 0;
      vipTicketsInput.value = e?.tickets?.vip ?? 0;
    });
  };

  updateTicketsBtn.onclick = () => {
    ticketsMessage.textContent = '';
    const eventId = selectEventTickets.value;
    if (!eventId) {
      ticketsMessage.textContent = 'Selecteer eerst een event.';
      ticketsMessage.className = 'error';
      return;
    }
    const normalCount = parseInt(normalTicketsInput.value);
    const vipCount = parseInt(vipTicketsInput.value);
    if (isNaN(normalCount) || normalCount < 0 || isNaN(vipCount) || vipCount < 0) {
      ticketsMessage.textContent = 'Voer geldige aantallen in.';
      ticketsMessage.className = 'error';
      return;
    }

    db.ref('events/' + eventId + '/tickets').set({
      normal: normalCount,
      vip: vipCount
    })
    .then(() => {
      ticketsMessage.textContent = 'Tickets bijgewerkt.';
      ticketsMessage.className = 'success';
      loadEventsTable();
    })
    .catch(() => {
      ticketsMessage.textContent = 'Bijwerken mislukt.';
      ticketsMessage.className = 'error';
    });
  };

  resetTicketsBtn.onclick = () => {
    ticketsMessage.textContent = '';
    const eventId = selectEventTickets.value;
    if (!eventId) {
      ticketsMessage.textContent = 'Selecteer eerst een event.';
      ticketsMessage.className = 'error';
      return;
    }
    if (!confirm('Weet je zeker dat je de tickets wilt resetten naar 0?')) return;

    db.ref('events/' + eventId + '/tickets').set({
      normal: 0,
      vip: 0
    })
    .then(() => {
      ticketsMessage.textContent = 'Tickets gereset.';
      ticketsMessage.className = 'success';
      normalTicketsInput.value = 0;
      vipTicketsInput.value = 0;
      loadEventsTable();
    })
    .catch(() => {
      ticketsMessage.textContent = 'Reset mislukt.';
      ticketsMessage.className = 'error';
    });
  };

  // VIP CODES MANAGEMENT
  const vipCodesTableBody = document.querySelector('#vipCodesTable tbody');
  const newVipCode = document.getElementById('newVipCode');
  const newVipLimit = document.getElementById('newVipLimit');
  const addVipCodeBtn = document.getElementById('addVipCodeBtn');
  const vipMessage = document.getElementById('vipMessage');

  function loadVipCodes() {
    vipCodesTableBody.innerHTML = '';
    db.ref('vipcodes').once('value').then(snap => {
      const codes = snap.val() || {};
      for (const key in codes) {
        const code = codes[key];
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(code.code)}</td>
          <td>${code.limit}</td>
          <td>${code.used || 0}</td>
          <td><button class="deleteVipCodeBtn" data-key="${key}">Verwijderen</button></td>
        `;
        vipCodesTableBody.appendChild(tr);
      }

      // Delete vip code buttons
      document.querySelectorAll('.deleteVipCodeBtn').forEach(btn => {
        btn.onclick = () => {
          if (!confirm('Weet je zeker dat je deze VIP code wilt verwijderen?')) return;
          const key = btn.dataset.key;
          db.ref('vipcodes/' + key).remove()
            .then(() => {
              vipMessage.textContent = 'VIP code verwijderd.';
              vipMessage.className = 'success';
              loadVipCodes();
            })
            .catch(() => {
              vipMessage.textContent = 'Verwijderen mislukt.';
              vipMessage.className = 'error';
            });
        };
      });
    });
  }

  addVipCodeBtn.onclick = () => {
    vipMessage.textContent = '';
    const code = newVipCode.value.trim();
    const limit = parseInt(newVipLimit.value);

    if (!code) {
      vipMessage.textContent = 'Code is verplicht.';
      vipMessage.className = 'error';
      return;
    }
    if (isNaN(limit) || limit < 1) {
      vipMessage.textContent = 'Voer een geldig limiet in (minimaal 1).';
      vipMessage.className = 'error';
      return;
    }

    // Check if code already exists (optional)
    db.ref('vipcodes').orderByChild('code').equalTo(code).once('value').then(snap => {
      if (snap.exists()) {
        vipMessage.textContent = 'Deze code bestaat al.';
        vipMessage.className = 'error';
        return;
      }

      const newKey = db.ref().child('vipcodes').push().key;
      db.ref('vipcodes/' + newKey).set({
        code,
        limit,
        used: 0
      })
      .then(() => {
        vipMessage.textContent = 'VIP code toegevoegd!';
        vipMessage.className = 'success';
        newVipCode.value = '';
        newVipLimit.value = '1';
        loadVipCodes();
      })
      .catch(() => {
        vipMessage.textContent = 'Toevoegen mislukt.';
        vipMessage.className = 'error';
      });
    });
  };

  // Logout button
  document.getElementById('logoutBtn').onclick = () => {
    if (confirm('Weet je zeker dat je wilt uitloggen?')) {
      managerContent.classList.add('hidden');
      loginSection.classList.remove('hidden');
      homeBtn.style.display = 'none';
      passwordInput.value = '';
      loginMessage.textContent = '';
    }
  };

  // Utilities
  function toInputDateTimeLocal(isoString) {
    if (!isoString) return '';
    const dt = new Date(isoString);
    // format yyyy-MM-ddThh:mm (voor datetime-local input)
    const yyyy = dt.getFullYear();
    const mm = String(dt.getMonth() + 1).padStart(2, '0');
    const dd = String(dt.getDate()).padStart(2, '0');
    const hh = String(dt.getHours()).padStart(2, '0');
    const min = String(dt.getMinutes()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}T${hh}:${min}`;
  }

  function statusText(code) {
    switch(code) {
      case 'wordt_mogelijk_afgelast': return 'Wordt mogelijk afgelast';
      case 'geannuleerd': return 'Geannuleerd';
      default: return 'Gewoon';
    }
  }

  function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/[&<>"']/g, m => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    })[m]);
  }
</script>

</body>
</html>
