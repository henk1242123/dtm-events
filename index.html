<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DTM Events - Tickets kopen</title>
<style>
  body { background:#121212; color:#e0e0e0; font-family:sans-serif; max-width:600px; margin:3rem auto; padding:1rem;}
  h1 { text-align:center; color:#4ade80; margin-bottom:1.5rem;}
  form { background:#1f1f1f; padding:1rem; border-radius:8px; }
  label, select, input, button { display:block; width:100%; margin-top:0.6rem; padding:0.6rem; font-size:1rem; border:none; border-radius:6px; box-sizing:border-box;}
  button { background:#4ade80; color:#121212; font-weight:700; cursor:pointer; transition: background 0.2s; }
  button:hover { background:#22c55e; }
  #msg { font-weight:700; text-align:center; margin-top:1rem; min-height:1.5em;}
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<h1>DTM Events - Tickets kopen</h1>

<form id="buyForm">
  <label for="eventSelect">Kies event:</label>
  <select id="eventSelect" required>
    <option value="" disabled selected>-- Selecteer een event --</option>
  </select>

  <label for="ticketType">Type ticket:</label>
  <select id="ticketType" required>
    <option value="" disabled selected>-- Kies ticket type --</option>
    <option value="normal">Normaal</option>
    <option value="vip">VIP</option>
  </select>

  <label for="vipCodeInput" style="display:none;">VIP Code (alleen voor VIP tickets):</label>
  <input type="text" id="vipCodeInput" style="display:none;" placeholder="Voer VIP code in"/>

  <button type="submit">Koop ticket</button>
</form>

<div id="msg"></div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBqXEvqXlqfFpfMkM0Z_7PCAdQxbCqS5tQ",
    authDomain: "dtm-events.firebaseapp.com",
    databaseURL: "https://dtm-events-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "dtm-events",
    storageBucket: "dtm-events.appspot.com",
    messagingSenderId: "742462370527",
    appId: "1:742462370527:web:19c713ca6a0f90acb2c9ac"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const eventSelect = document.getElementById('eventSelect');
  const ticketType = document.getElementById('ticketType');
  const vipCodeInput = document.getElementById('vipCodeInput');
  const vipCodeLabel = vipCodeInput.previousElementSibling;
  const msgEl = document.getElementById('msg');

  // Toon VIP code invoer alleen bij VIP ticket
  ticketType.addEventListener('change', () => {
    if(ticketType.value === 'vip') {
      vipCodeInput.style.display = 'block';
      vipCodeLabel.style.display = 'block';
    } else {
      vipCodeInput.style.display = 'none';
      vipCodeLabel.style.display = 'none';
      vipCodeInput.value = '';
    }
  });

  // Events laden in dropdown
  db.ref('events').once('value').then(snap => {
    const events = snap.val() || {};
    for (const key in events) {
      const ev = events[key];
      const option = document.createElement('option');
      option.value = key;
      option.textContent = `${ev.name} (${ev.date})`;
      eventSelect.appendChild(option);
    }
  });

  document.getElementById('buyForm').addEventListener('submit', async e => {
    e.preventDefault();
    msgEl.textContent = '';

    const eventKey = eventSelect.value;
    const type = ticketType.value;
    const vipCode = vipCodeInput.value.trim();

    if (!eventKey || !type) {
      msgEl.textContent = 'Vul alle velden in.';
      return;
    }

    // Check VIP code als VIP ticket
    if (type === 'vip') {
      if (!vipCode) {
        msgEl.textContent = 'Voer een VIP code in voor VIP tickets.';
        return;
      }
      const vipSnap = await db.ref(`vipPasswords/${vipCode}`).get();
      if (!vipSnap.exists()) {
        msgEl.textContent = 'VIP code ongeldig.';
        return;
      }
      const vipData = vipSnap.val();
      if (vipData.used >= vipData.limit) {
        msgEl.textContent = 'VIP code is al gebruikt.';
        return;
      }
    }

    // Ticket nummer bepalen
    const ticketNumSnap = await db.ref(`events/${eventKey}/tickets/${type}`).get();
    const currentTickets = ticketNumSnap.exists() ? ticketNumSnap.val() : 0;
    const newTicketNum = currentTickets + 1;

    // Sla ticket op in db (onder /tickets met info)
    const ticketData = {
      eventKey,
      ticketType: type,
      number: newTicketNum,
      timestamp: Date.now()
    };

    // Als VIP, update ook vipPasswords used count
    const updates = {};
    updates[`events/${eventKey}/tickets/${type}`] = newTicketNum;
    updates[`tickets/${eventKey}/${type}/${newTicketNum}`] = ticketData;

    if (type === 'vip') {
      const vipUsedRef = db.ref(`vipPasswords/${vipCode}/used`);
      const vipUsedSnap = await vipUsedRef.get();
      const vipUsed = vipUsedSnap.exists() ? vipUsedSnap.val() : 0;
      updates[`vipPasswords/${vipCode}/used`] = vipUsed + 1;
      updates[`tickets/${eventKey}/${type}/${newTicketNum}/vipCode`] = vipCode;
    }

    await db.ref().update(updates);

    // Redirect naar bedankt pagina met eventKey en ticket nummer en type in URL
    window.location.href = `bedankt.html?event=${eventKey}&type=${type}&num=${newTicketNum}`;
  });
</script>

</body>
</html>
