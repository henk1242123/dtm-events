<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DTM Events - Tickets kopen</title>
<style>
  body {
    background: #121212;
    color: #e0e0e0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    max-width: 480px;
    margin: 3rem auto;
    padding: 1rem;
  }
  h1 {
    text-align: center;
    color: #4ade80;
    margin-bottom: 2rem;
    font-weight: 700;
  }
  select, input[type=text], button {
    width: 100%;
    padding: 0.6rem 0.8rem;
    margin: 0.5rem 0;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
    box-sizing: border-box;
  }
  button {
    background-color: #4ade80;
    color: #121212;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.2s ease;
    border: none;
  }
  button:hover:not(:disabled) {
    background-color: #22c55e;
  }
  button:disabled {
    background-color: #555;
    cursor: not-allowed;
  }
  #vipSection {
    margin-top: 1rem;
    display: none;
  }
  #vipCodeInput {
    margin-bottom: 0.4rem;
  }
  #vipMessage, #mainMessage {
    font-weight: 600;
    min-height: 1.5em;
    margin-top: 0.4rem;
  }
  #vipMessage {
    color: #facc15;
  }
  #mainMessage {
    color: #4ade80;
  }
  #eventDetails {
    margin-bottom: 1rem;
    font-size: 0.9rem;
    color: #bbb;
    text-align: center;
  }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<h1>DTM Events - Tickets kopen</h1>

<label for="eventsSelect">Kies een event</label>
<select id="eventsSelect">
  <option value="" disabled selected>-- Kies een event --</option>
</select>

<div id="eventDetails"></div>

<div id="ticketsSold" style="text-align:center; font-size:0.9rem; color:#aaa; margin-bottom: 1rem;"></div>

<button id="buyNormal" disabled>Koop Normaal Ticket (15 Robux)</button>

<div id="vipSection">
  <input type="text" id="vipCodeInput" placeholder="Voer VIP code in" autocomplete="off" />
  <button id="verifyVip">Verifieer VIP Code</button>
  <div id="vipMessage"></div>
  <button id="buyVip" disabled>Koop VIP Ticket (35 Robux)</button>
</div>

<div id="mainMessage" role="alert" aria-live="polite"></div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAq2hnWZnhoMzVC_NZ3efND3xEkijRy23k",
    authDomain: "dtm-evemts.firebaseapp.com",
    databaseURL: "https://dtm-evemts-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "dtm-evemts",
    storageBucket: "dtm-evemts.firebasestorage.app",
    messagingSenderId: "673592896357",
    appId: "1:673592896357:web:4aa0d051ad738c12a80f8c",
    measurementId: "G-GFRH4KY8GF"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const eventsSelect = document.getElementById('eventsSelect');
  const eventDetails = document.getElementById('eventDetails');
  const ticketsSold = document.getElementById('ticketsSold');
  const buyNormalBtn = document.getElementById('buyNormal');
  const vipSection = document.getElementById('vipSection');
  const vipCodeInput = document.getElementById('vipCodeInput');
  const verifyVipBtn = document.getElementById('verifyVip');
  const vipMessage = document.getElementById('vipMessage');
  const buyVipBtn = document.getElementById('buyVip');
  const mainMessage = document.getElementById('mainMessage');

  let currentEventKey = null;
  let vipCodeValid = false;
  let vipCode = '';

  function clearMessages() {
    mainMessage.textContent = '';
    vipMessage.textContent = '';
  }

  function formatDate(d) {
    if (!d) return '';
    const dt = new Date(d);
    return dt.toLocaleDateString('nl-NL', { day:'2-digit', month:'long', year:'numeric' });
  }

  // Laad events en vul dropdown
  function loadEvents() {
    db.ref('events').on('value', snapshot => {
      const events = snapshot.val() || {};
      eventsSelect.innerHTML = '<option value="" disabled selected>-- Kies een event --</option>';
      for (const key in events) {
        const ev = events[key];
        eventsSelect.innerHTML += `<option value="${key}">${ev.name} â€” ${formatDate(ev.date)}</option>`;
      }
    });
  }

  // Update event details en ticket info
  function updateEventInfo(key) {
    if (!key) {
      eventDetails.textContent = '';
      ticketsSold.textContent = '';
      buyNormalBtn.disabled = true;
      vipSection.style.display = 'none';
      vipCodeInput.value = '';
      vipMessage.textContent = '';
      buyVipBtn.disabled = true;
      vipCodeValid = false;
      vipCode = '';
      return;
    }
    currentEventKey = key;
    clearMessages();
    db.ref(`events/${key}`).once('value').then(snap => {
      const ev = snap.val();
      if (!ev) return;
      eventDetails.textContent = `Datum: ${formatDate(ev.date)}`;
      const normal = ev.tickets?.normal || 0;
      const vip = ev.tickets?.vip || 0;
      ticketsSold.textContent = `Normale tickets verkocht: ${normal} | VIP tickets verkocht: ${vip}`;
      buyNormalBtn.disabled = false;
      vipSection.style.display = 'block';
      buyVipBtn.disabled = true;
      vipCodeValid = false;
      vipCodeInput.value = '';
      vipMessage.textContent = '';
    });
  }

  // Normaal ticket kopen
  buyNormalBtn.onclick = () => {
    clearMessages();
    if (!currentEventKey) return;
    db.ref(`events/${currentEventKey}/tickets/normal`).transaction(count => (count || 0) + 1)
      .then(() => {
        mainMessage.style.color = '#4ade80';
        mainMessage.textContent = 'ðŸŽ‰ Je hebt een normaal ticket gekocht!';
        updateEventInfo(currentEventKey);
      })
      .catch(() => {
        mainMessage.style.color = 'crimson';
        mainMessage.textContent = 'Er is iets misgegaan, probeer later opnieuw.';
      });
  };

  // VIP code verifiÃ«ren
  verifyVipBtn.onclick = () => {
    const code = vipCodeInput.value.trim();
    vipMessage.style.color = '#facc15';
    vipMessage.textContent = 'Controleren...';
    buyVipBtn.disabled = true;
    if (!code) {
      vipMessage.style.color = 'crimson';
      vipMessage.textContent = 'Vul een VIP code in.';
      return;
    }
    db.ref(`vipPasswords/${code}`).get().then(snap => {
      const data = snap.val();
      if (!data) {
        vipMessage.style.color = 'crimson';
        vipMessage.textContent = 'Ongeldige VIP code.';
        vipCodeValid = false;
        buyVipBtn.disabled = true;
        return;
      }
      if ((data.used || 0) >= (data.limit || 0)) {
        vipMessage.style.color = 'crimson';
        vipMessage.textContent = 'Deze VIP code is al gebruikt of verlopen.';
        vipCodeValid = false;
        buyVipBtn.disabled = true;
        return;
      }
      vipMessage.style.color = '#4ade80';
      vipMessage.textContent = 'VIP code geverifieerd! Je kunt nu VIP ticket kopen.';
      vipCodeValid = true;
      buyVipBtn.disabled = false;
      vipCode = code;
    }).catch(() => {
      vipMessage.style.color = 'crimson';
      vipMessage.textContent = 'Fout bij controle, probeer later opnieuw.';
      vipCodeValid = false;
      buyVipBtn.disabled = true;
    });
  };

  // VIP ticket kopen
  buyVipBtn.onclick = () => {
    clearMessages();
    if (!currentEventKey || !vipCodeValid) {
      mainMessage.style.color = 'crimson';
      mainMessage.textContent = 'VIP code niet geverifieerd.';
      return;
    }
    // update ticket count & VIP code usage atomisch
    const eventTicketsRef = db.ref(`events/${currentEventKey}/tickets/vip`);
    const vipCodeRef = db.ref(`vipPasswords/${vipCode}`);

    // gebruik transaction om race-condities te voorkomen
    vipCodeRef.transaction(data => {
      if (data) {
        if ((data.used || 0) >= (data.limit || 0)) {
          return; // code al gebruikt, afbreken
        }
        data.used = (data.used || 0) + 1;
        return data;
      }
      return; // code bestaat niet, afbreken
    }, (error, committed, snapshot) => {
      if (error || !committed) {
        mainMessage.style.color = 'crimson';
        mainMessage.textContent = 'VIP code is al gebruikt of ongeldig.';
        buyVipBtn.disabled = true;
        vipCodeValid = false;
        return;
      }
      // nu tickets verhogen
      eventTicketsRef.transaction(count => (count || 0) + 1).then(() => {
        mainMessage.style.color = '#4ade80';
        mainMessage.textContent = 'ðŸŽ‰ VIP ticket gekocht! Bedankt!';
        buyVipBtn.disabled = true;
        vipCodeValid = false;
        vipCodeInput.value = '';
        vipMessage.textContent = '';
        updateEventInfo(currentEventKey);
      }).catch(() => {
        mainMessage.style.color = 'crimson';
        mainMessage.textContent = 'Fout bij kopen ticket, probeer later.';
      });
    });
  };

  // Event selectie wijzigen
  eventsSelect.onchange = () => {
    updateEventInfo(eventsSelect.value);
  };

  // Manager pagina openen met CTRL+L
  window.addEventListener('keydown', e => {
    if (e.ctrlKey && (e.key === 'l' || e.key === 'L')) {
      e.preventDefault();
      window.location.href = 'manager.html';
    }
  });

  loadEvents();
</script>

</body>
</html>
