<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DTM Events - Tickets kopen</title>
<style>
  body {
    background: #121212;
    color: #e0e0e0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    max-width: 600px;
    margin: 3rem auto;
    padding: 1rem;
  }
  h1 {
    text-align: center;
    color: #4ade80;
    margin-bottom: 1rem;
    font-weight: 700;
  }
  select, input, button {
    width: 100%;
    padding: 0.6rem 0.8rem;
    margin-top: 0.5rem;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
    box-sizing: border-box;
  }
  button {
    background-color: #4ade80;
    color: #121212;
    font-weight: 700;
    cursor: pointer;
    margin-top: 1rem;
    border: none;
    transition: background-color 0.2s ease;
  }
  button:hover {
    background-color: #22c55e;
  }
  .section {
    background: #1f1f1f;
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1.5rem;
  }
  #countdown {
    font-size: 1.2rem;
    font-weight: 700;
    text-align: center;
    margin-bottom: 1rem;
    color: #86efac;
  }
  #mainMessage {
    margin-top: 1rem;
    font-weight: 700;
    min-height: 1.5em;
  }
  label {
    font-weight: 600;
    margin-top: 0.8rem;
    display: block;
  }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<h1>DTM Events - Tickets kopen</h1>

<div class="section">
  <label for="eventsSelect">Kies een event:</label>
  <select id="eventsSelect" aria-label="Selecteer een event"></select>

  <div id="countdown" aria-live="polite" role="timer"></div>

  <div>
    <strong>Tickets verkocht:</strong><br>
    Normaal: <span id="normalTicketsCount">0</span><br>
    VIP: <span id="vipTicketsCount">0</span>
  </div>
</div>

<div class="section">
  <h2>Normaal ticket kopen (gratis)</h2>
  <button id="buyNormalBtn">Koop normaal ticket</button>
</div>

<div class="section">
  <h2>VIP ticket kopen (35 Robux) met code</h2>
  <label for="vipCodeInput">VIP code:</label>
  <input type="text" id="vipCodeInput" autocomplete="off" aria-describedby="vipMessage" />
  <div id="vipMessage" style="color:#fbbf24; margin-bottom: 0.5rem;"></div>
  <button id="buyVipBtn" disabled>Koop VIP ticket</button>
</div>

<div id="mainMessage" aria-live="polite"></div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAq2hnWZnhoMzVC_NZ3efND3xEkijRy23k",
    authDomain: "dtm-evemts.firebaseapp.com",
    databaseURL: "https://dtm-evemts-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "dtm-evemts",
    storageBucket: "dtm-evemts.firebasestorage.app",
    messagingSenderId: "673592896357",
    appId: "1:673592896357:web:4aa0d051ad738c12a80f8c",
    measurementId: "G-GFRH4KY8GF"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const eventsSelect = document.getElementById('eventsSelect');
  const countdown = document.getElementById('countdown');
  const normalTicketsCount = document.getElementById('normalTicketsCount');
  const vipTicketsCount = document.getElementById('vipTicketsCount');
  const buyNormalBtn = document.getElementById('buyNormalBtn');
  const buyVipBtn = document.getElementById('buyVipBtn');
  const vipCodeInput = document.getElementById('vipCodeInput');
  const vipMessage = document.getElementById('vipMessage');
  const mainMessage = document.getElementById('mainMessage');

  let currentEventKey = null;
  let vipCodeValid = false;

  // Timer interval id
  let timerInterval = null;

  function updateCountdown(dateString) {
    clearInterval(timerInterval);
    function update() {
      const eventDate = new Date(dateString);
      const now = new Date();
      const diff = eventDate - now;
      if (diff <= 0) {
        countdown.textContent = 'Het event is bezig of voorbij.';
        clearInterval(timerInterval);
        return;
      }
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
      const minutes = Math.floor((diff / (1000 * 60)) % 60);
      const seconds = Math.floor((diff / 1000) % 60);
      countdown.textContent = `Nog ${days} dagen ${hours} uur ${minutes} min ${seconds} sec tot het event`;
    }
    update();
    timerInterval = setInterval(update, 1000);
  }

  // Laad events in dropdown
  function loadEvents() {
    db.ref('events').on('value', snapshot => {
      const events = snapshot.val() || {};
      eventsSelect.innerHTML = '';
      if (Object.keys(events).length === 0) {
        eventsSelect.innerHTML = '<option>Geen events beschikbaar</option>';
        countdown.textContent = '';
        normalTicketsCount.textContent = '0';
        vipTicketsCount.textContent = '0';
        currentEventKey = null;
        return;
      }
      for (const key in events) {
        const ev = events[key];
        const option = document.createElement('option');
        option.value = key;
        option.textContent = `${ev.name} (${new Date(ev.date).toLocaleDateString('nl-NL')})`;
        eventsSelect.appendChild(option);
      }
      // Selecteer eerste event standaard
      if (!currentEventKey) {
        currentEventKey = eventsSelect.value;
      }
      updateEventInfo(currentEventKey);
    });
  }

  // Update info bij event wissel
  function updateEventInfo(eventKey) {
    currentEventKey = eventKey;
    db.ref(`events/${eventKey}`).once('value').then(snapshot => {
      const ev = snapshot.val();
      if (!ev) return;
      normalTicketsCount.textContent = ev.tickets?.normal || 0;
      vipTicketsCount.textContent = ev.tickets?.vip || 0;
      updateCountdown(ev.date);
    });
    resetVipCode();
  }

  eventsSelect.addEventListener('change', () => {
    updateEventInfo(eventsSelect.value);
  });

  // Normaal ticket kopen (gratis)
  buyNormalBtn.onclick = () => {
    if (!currentEventKey) return;
    const eventNormalTicketsRef = db.ref(`events/${currentEventKey}/tickets/normal`);
    eventNormalTicketsRef.transaction(count => (count || 0) + 1).then(() => {
      mainMessage.style.color = '#4ade80';
      mainMessage.textContent = 'ðŸŽ‰ Normaal ticket gekocht! Veel plezier!';
    }).catch(() => {
      mainMessage.style.color = 'crimson';
      mainMessage.textContent = 'Fout bij kopen ticket, probeer later.';
    });
  };

  // VIP code validatie
  vipCodeInput.oninput = () => {
    const code = vipCodeInput.value.trim();
    vipMessage.textContent = '';
    buyVipBtn.disabled = true;
    vipCodeValid = false;
    if (!code) return;

    db.ref(`vipPasswords/${code}`).once('value').then(snapshot => {
      const data = snapshot.val();
      if (!data) {
        vipMessage.textContent = 'VIP code niet gevonden.';
        return;
      }
      if ((data.used || 0) >= (data.limit || 0)) {
        vipMessage.textContent = 'Deze VIP code is al gebruikt of limiet bereikt.';
        return;
      }
      vipMessage.textContent = 'VIP code geldig!';
      buyVipBtn.disabled = false;
      vipCodeValid = true;
    }).catch(() => {
      vipMessage.textContent = 'Fout bij controleren VIP code.';
    });
  };

  // VIP ticket kopen
  buyVipBtn.onclick = () => {
    if (!currentEventKey || !vipCodeValid) {
      mainMessage.style.color = 'crimson';
      mainMessage.textContent = 'VIP code niet geverifieerd.';
      return;
    }

    const vipCode = vipCodeInput.value.trim();
    const eventVipTicketsRef = db.ref(`events/${currentEventKey}/tickets/vip`);
    const vipCodeRef = db.ref(`vipPasswords/${vipCode}`);

    vipCodeRef.transaction(data => {
      if (data) {
        if ((data.used || 0) >= (data.limit || 0)) {
          return; // code al gebruikt, stop
        }
        data.used = (data.used || 0) + 1;
        return data;
      }
      return; // code bestaat niet, stop
    }, (error, committed, snapshot) => {
      if (error || !committed) {
        mainMessage.style.color = 'crimson';
        mainMessage.textContent = 'VIP code is al gebruikt of ongeldig.';
        buyVipBtn.disabled = true;
        vipCodeValid = false;
        return;
      }
      eventVipTicketsRef.transaction(count => (count || 0) + 1).then(() => {
        mainMessage.style.color = '#4ade80';
        mainMessage.textContent = 'ðŸŽ‰ VIP ticket gekocht! Bedankt!';
        buyVipBtn.disabled = true;
        vipCodeValid = false;
        vipCodeInput.value = '';
        vipMessage.textContent = '';
        updateEventInfo(currentEventKey);
      }).catch(() => {
        mainMessage.style.color = 'crimson';
        mainMessage.textContent = 'Fout bij kopen ticket, probeer later.';
      });
    });
  };

  // Manager pagina openen met CTRL+L
  window.addEventListener('keydown', e => {
    if (e.ctrlKey && (e.key === 'l' || e.key === 'L')) {
      e.preventDefault();
      window.location.href = 'manager.html';
    }
  });

  loadEvents();
</script>

</body>
</html>
