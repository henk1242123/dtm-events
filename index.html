<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DTM Events - Tickets kopen</title>
  <link rel="icon" type="image/png" href="dtm-favicon.png">
  <style>
    body { background: #121212; color: #e0e0e0; font-family: sans-serif; max-width: 600px; margin: 3rem auto; padding: 1rem; }
    h1 { text-align: center; color: #4ade80; margin-bottom: 1rem; }
    .section { background: #1f1f1f; border-radius: 10px; padding: 1rem; margin-bottom: 1.5rem; }
    select, input, button { width: 100%; padding: 0.6rem; margin-top: 0.5rem; border-radius: 8px; border: none; font-size: 1rem; box-sizing: border-box; }
    button { background: #4ade80; color: #121212; font-weight: 700; cursor: pointer; transition: background 0.2s; }
    button:hover:not(:disabled) { background: #22c55e; }
    button:disabled { background: #555; cursor: not-allowed; }
    #countdown { font-size: 1.1rem; text-align: center; margin-top: 0.5rem; color: #86efac; }
    #mainMessage { margin-top: 1rem; font-weight: 700; min-height: 1.5em; }
    label { font-weight: 600; margin-top: 0.8rem; display: block; }
    .eventStatus {
      color: #f87171;
      font-weight: 900;
      font-size: 1.2rem;
      background: #1c1c1c;
      padding: 1rem;
      border: 2px solid #dc2626;
      border-radius: 8px;
      margin-bottom: 1rem;
      text-align: center;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<h1>DTM Events - Tickets kopen</h1>

<div class="section">
  <div id="eventStatus"></div>
  <label>Kies een event</label>
  <select id="eventsSelect"></select>
  <div>
    <strong>Tickets verkocht:</strong><br>
    Normaal: <span id="normalCount">0</span> | VIP: <span id="vipCount">0</span>
  </div>
</div>

<div class="section">
  <h2>Normaal ticket (gratis)</h2>
  <button id="buyNormalBtn">Koop normaal ticket</button>
</div>

<div class="section">
  <h2>VIP ticket (code vereist)</h2>
  <label>VIP code:</label>
  <input type="text" id="vipCodeInput" autocomplete="off" />
  <div id="vipMessage" style="color:#fbbf24; margin-top:0.5rem;"></div>
  <button id="buyVipBtn" disabled>Koop VIP ticket</button>
</div>

<div id="mainMessage" aria-live="polite"></div>
<div id="countdown"></div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBz-Nt3XmpN-t3x-AkkE4cX6pQn2OD2AIU",
    authDomain: "dtm-events.firebaseapp.com",
    databaseURL: "https://dtm-events-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "dtm-events",
    storageBucket: "dtm-events.appspot.com",
    messagingSenderId: "944781390391",
    appId: "1:944781390391:web:e22fe2df9c13aa3fa16496"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const eventsSelect = document.getElementById('eventsSelect');
  const buyNormalBtn = document.getElementById('buyNormalBtn');
  const buyVipBtn = document.getElementById('buyVipBtn');
  const vipCodeInput = document.getElementById('vipCodeInput');
  const vipMessage = document.getElementById('vipMessage');
  const mainMessage = document.getElementById('mainMessage');
  const normalCount = document.getElementById('normalCount');
  const vipCount = document.getElementById('vipCount');
  const countdownEl = document.getElementById('countdown');
  const eventStatus = document.getElementById('eventStatus');

  let currentEvent = null, vipValid = false;

  function loadEvents() {
    db.ref('events').on('value', snap => {
      const evs = snap.val() || {};
      eventsSelect.innerHTML = '';
      for (const k in evs) {
        const e = evs[k];
        const dateTime = new Date(e.date).toLocaleString('nl-NL');
        eventsSelect.innerHTML += `<option value="${k}">${e.name} (${dateTime})</option>`;
      }
      eventsSelect.onchange = () => selectEvent(eventsSelect.value);
      if (!currentEvent && eventsSelect.options.length) selectEvent(eventsSelect.value);
    });
  }

  function selectEvent(key) {
    currentEvent = key;
    vipValid = false;
    vipMessage.textContent = '';
    buyVipBtn.disabled = true;
    normalCount.textContent = vipCount.textContent = '';
    eventStatus.innerHTML = '';

    db.ref(`events/${key}`).once('value').then(snap => {
      const ev = snap.val();
      if (!ev) return;
      if (ev.status === 'mogelijk_afgelast') {
        eventStatus.innerHTML = '<div class="eventStatus">‚ÄºÔ∏è Dit event wordt mogelijk afgelast</div>';
      } else if (ev.status === 'afgelast') {
        eventStatus.innerHTML = '<div class="eventStatus">üö´ Dit event is afgelast. Er kunnen geen tickets worden gekocht.</div>';
        buyNormalBtn.disabled = true;
        buyVipBtn.disabled = true;
      } else if (ev.status === 'voorbij') {
        eventStatus.innerHTML = '<div class="eventStatus">‚è±Ô∏è Dit event is inmiddels voorbij.</div>';
        buyNormalBtn.disabled = true;
        buyVipBtn.disabled = true;
      } else {
        buyNormalBtn.disabled = false;
      }

      normalCount.textContent = ev.tickets?.normal || 0;
      vipCount.textContent = ev.tickets?.vip || 0;
      startCountdown(ev.date);
    });
  }

  let timer;
  function startCountdown(dateStr) {
    clearInterval(timer);
    const target = new Date(dateStr);
    timer = setInterval(() => {
      const diff = target - new Date();
      if (diff <= 0) { countdownEl.textContent = 'Event is begonnen of voorbij.'; clearInterval(timer); return; }
      const d = Math.floor(diff / 86400000), h = Math.floor((diff / 3600000) % 24), m = Math.floor((diff / 60000) % 60), s = Math.floor((diff / 1000) % 60);
      countdownEl.textContent = `Nog ${d}d ${h}u ${m}m ${s}s`;
    }, 1000);
  }

  buyNormalBtn.onclick = () => {
    if (!currentEvent) return;
    db.ref(`events/${currentEvent}/tickets/normal`).transaction(c => (c || 0) + 1)
      .then(() => mainMessage.textContent = 'üéâ Normaal ticket gekocht!');
  };

  vipCodeInput.oninput = () => {
    vipMessage.textContent = '';
    buyVipBtn.disabled = true;
    vipValid = false;
    if (!currentEvent) return;
    const code = vipCodeInput.value.trim();
    if (!code) return;
    db.ref(`vipPasswords/${code}`).once('value').then(snap => {
      const d = snap.val();
      if (!d) { vipMessage.textContent = 'VIP code ongeldig.'; return; }
      if ((d.used || 0) >= (d.limit || 0)) { vipMessage.textContent = 'VIP code limiet bereikt.'; return; }
      vipMessage.textContent = 'VIP code geldig!';
      vipValid = true; buyVipBtn.disabled = false;
    });
  };

  buyVipBtn.onclick = () => {
    if (!vipValid) return;
    const code = vipCodeInput.value.trim();
    const codeRef = db.ref(`vipPasswords/${code}`);
    const vipRef = db.ref(`events/${currentEvent}/tickets/vip`);
    codeRef.transaction(d => {
      if (!d || (d.used || 0) >= (d.limit || 0)) return;
      d.used = (d.used || 0) + 1; return d;
    }, (e, comm) => {
      if (!comm) { mainMessage.textContent = 'VIP code ongeldig of gebruikt.'; return; }
      vipRef.transaction(c => (c || 0) + 1)
        .then(() => mainMessage.textContent = 'üéâ VIP ticket gekocht!')
        .then(() => selectEvent(currentEvent));
    });
  };

  window.addEventListener('keydown', e => {
    if (e.ctrlKey && (e.key === 'l' || e.key === 'L')) {
      e.preventDefault(); window.location = 'manager.html';
    }
  });

  loadEvents();
</script>

</body>
</html>
